{% extends 'cupper/base.html' %}

{% block content %}

<div>
    <div>Вы находитесь в комнате #<p style="display: inline" id="room">{{ room.id }}</p></div>
    <p id="u1">
        {% if user.id in room.user_channels %}
            Состав комнаты:
            {% for key, value in room.user_channels.items %}
                {{ key }}
            {% endfor %}
        {% endif %}
    </p>
</div>

    <button id="go">Присоединиться</button>
    <button id="leave">Покинуть</button>

{% endblock %}

{% block script_block %}
    <script>
        $(document).ready(function () {
            var ws_path = "/cupper/stream";
            var ws = new WebSocket("ws://" + window.location.host + ws_path);

            var room_id = document.getElementById("room").innerHTML;

            var user_id = "{{ user.id }}";

            ws.onmessage = function (msg) {
                var data = JSON.parse(msg.data)
                if (data.user_leave){
                    document.getElementById("u1").innerHTML = ""
                }
                if (data.user_id) {
                    document.getElementById("u1").innerHTML = "Состав комнаты: " + data.user_id;
                }
            }

            $('#go').click(function (e) {
                ws.send(JSON.stringify({
                    "command": "join",
                    "room": room_id,
                    "user_id": user_id,

                }));

                //document.getElementById('go').id = 'leave';
                //document.getElementById('leave').innerHTML = 'leave';
            })

            $('#leave').click(function (e) {
                ws.send(JSON.stringify({
                    "command": "leave",
                    "room": room_id,
                    "user_id": user_id,
                }))

                //document.getElementById('leave').id = 'go';
                //document.getElementById('go').innerHTML = 'go';
            })
        });

    </script>
{% endblock %}