{% extends 'cupper/base.html' %}

{% block content %}

<div>
    <div>Вы находитесь в комнате #<p style="display: inline" id="room">{{ room.id }}</p></div>
    <p id="u1">
        {% if user.id in room.user_channels %}
            Состав комнаты:
            {% for key, value in room.user_channels.items %}
                {{ key }}
            {% endfor %}
        {% endif %}
    </p>
</div>

    <p id="if-winner"></p>

    <button id="go">Присоединиться</button>
    <button id="leave">Покинуть</button>

    <div id="link_to_final"></div>

    <div id="game">

    </div>

{% endblock %}

{% block script_block %}
    <script>
        $(document).ready(function () {
            var ws_path = "/cupper/stream";
            var ws = new WebSocket("ws://" + window.location.host + ws_path);

            var room_id = document.getElementById("room").innerHTML;

            var user_id = "{{ user.id }}";
            var room_type = "{{ room.type }}"


            ws.onmessage = function (msg) {
                var data = JSON.parse(msg.data)
                if (data.user_leave){
                    document.getElementById("u1").innerHTML = ""
                }
                if (data.user_id) {
                    document.getElementById("u1").innerHTML = "Состав комнаты: " + data.user_id;
                }
                if (data.game_start) {
                    var img_src = data.image;
                    document.getElementById("game").innerHTML = "<img width='30%' src='" + '/media/' + img_src + "'/>"
                    document.getElementById("game").innerHTML += "<textarea id='res'/>"
                    document.getElementById("game").innerHTML += "<button id='go_result'>Ответить</button>"
                    $('#go_result').click( function (e) {
                        var res = document.getElementById("res").value;
                        ws.send(JSON.stringify({
                            "command": "answer",
                            "room": room_id,
                            "user_id": user_id,
                            "answer": res,
                            "room_type": room_type

                        }));
                    });
                }
                if(data.ifwinner) {
                    if (data.ifwinner === true) {
                        document.getElementById("if-winner").innerHTML = "YOU WIN!!!!!!!!!!!"
                        document.getElementById("u1").innerHTML = document.getElementById("game").innerHTML = ""
                    }
                }
                if(data.ifloser) {
                    document.getElementById("if-winner").innerHTML = "YOU LOSE!!!!!!!!!!!"
                    document.getElementById("u1").innerHTML = document.getElementById("game").innerHTML = ""

                }
                if(data.link_to_final_room){
                    var link = data.link_to_final_room;
                    alert(link)
                    document.getElementById("link_to_final").innerHTML = "<a href='" + link + ">GO</a>"
                }
            }

            $('#go').click(function (e) {
                ws.send(JSON.stringify({
                    "command": "join",
                    "room": room_id,
                    "user_id": user_id,
                    "room_type": room_type

                }));

                document.getElementById("if-winner").innerHTML = ""

                //document.getElementById('go').id = 'leave';
                //document.getElementById('leave').innerHTML = 'leave';
            })

            $('#leave').click(function (e) {
                ws.send(JSON.stringify({
                    "command": "leave",
                    "room": room_id,
                    "user_id": user_id,
                    "room_type": room_type
                }))

                //document.getElementById('leave').id = 'go';
                //document.getElementById('go').innerHTML = 'go';
            })
        });

    </script>
{% endblock %}